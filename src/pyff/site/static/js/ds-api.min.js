(function(){if(!window.console){window.console={}}if(!window.console.log){window.console.log=function(){}}}());var hex_sha1=function(){var j=String.fromCharCode;function k(l){return i(e(h(l),l.length*8))}function f(n){var m="";var l;for(var o in n){l=n.charCodeAt(o);m+=((l>>4)&15).toString(16)+(l&15).toString(16)}return m}function c(n){var m="";var o=-1;var l,p;while(++o<n.length){l=n.charCodeAt(o);p=o+1<n.length?n.charCodeAt(o+1):0;if(55296<=l&&l<=56319&&56320<=p&&p<=57343){l=65536+((l&1023)<<10)+(p&1023);o++}if(l<=127){m+=j(l)}else{if(l<=2047){m+=j(192|((l>>6)&31),128|(l&63))}else{if(l<=65535){m+=j(224|((l>>12)&15),128|((l>>6)&63),128|(l&63))}else{if(l<=2097151){m+=j(240|((l>>18)&7),128|((l>>12)&63),128|((l>>6)&63),128|(l&63))}}}}}return m}function h(m){var l=[];for(var n=0;n<m.length*8;n+=8){l[n>>5]|=(m.charCodeAt(n/8)&255)<<(24-n%32)}return l}function i(m){var l="";for(var n=0;n<m.length*32;n+=8){l+=j((m[n>>5]>>(24-n%32))&255)}return l}function e(B,s){B[s>>5]|=128<<(24-s%32);B[((s+64>>9)<<4)+15]=s;var C=[];var A=1732584193;var z=-271733879;var y=-1732584194;var v=271733878;var u=-1009589776;for(var p=0;p<B.length;p+=16){var r=A;var q=z;var o=y;var n=v;var l=u;for(var m=0;m<80;m++){if(m<16){C[m]=B[p+m]}else{C[m]=g(C[m-3]^C[m-8]^C[m-14]^C[m-16],1)}var D=d(d(g(A,5),a(m,z,y,v)),d(d(u,C[m]),b(m)));u=v;v=y;y=g(z,30);z=A;A=D}A=d(A,r);z=d(z,q);y=d(y,o);v=d(v,n);u=d(u,l)}return[A,z,y,v,u]}function a(m,l,o,n){if(m<20){return(l&o)|((~l)&n)}if(m<40){return l^o^n}if(m<60){return(l&o)|(l&n)|(o&n)}return l^o^n}function b(l){return(l<20)?1518500249:(l<40)?1859775393:(l<60)?-1894007588:-899497514}function d(l,o){var n=(l&65535)+(o&65535);var m=(l>>16)+(o>>16)+(n>>16);return(m<<16)|(n&65535)}function g(l,m){return(l<<m)|(l>>>(32-m))}return function(l){return f(k(c(l)))}}();!function(b){function a(d,c){c=c||{},this._id=a._generateUUID(),this._promise=c.promise||Promise,this._frameId=c.frameId||"CrossStorageClient-"+this._id,this._origin=a._getOrigin(d),this._requests={},this._connected=!1,this._closed=!1,this._count=0,this._timeout=c.timeout||5000,this._listener=null,this._installListener();var f;c.frameId&&(f=document.getElementById(c.frameId)),f&&this._poll(),f=f||this._createFrame(d),this._hub=f.contentWindow}a.frameStyle={display:"none",position:"absolute",top:"-999px",left:"-999px"},a._getOrigin=function(f){var c,d,g;return c=document.createElement("a"),c.href=f,c.host||(c=window.location),d=c.protocol&&":"!==c.protocol?c.protocol:window.location.protocol,g=d+"//"+c.host,g=g.replace(/:80$|:443$/,"")},a._generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(f){var c=16*Math.random()|0,d="x"==f?c:3&c|8;return d.toString(16)})},a.prototype.onConnect=function(){var c=this;return this._connected?this._promise.resolve():this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):(this._requests.connect||(this._requests.connect=[]),new this._promise(function(d,e){var f=setTimeout(function(){e(new Error("CrossStorageClient could not connect"))},c._timeout);c._requests.connect.push(function(g){return clearTimeout(f),g?e(g):(d(),void 0)})}))},a.prototype.set=function(d,c){return this._request("set",{key:d,value:c})},a.prototype.get=function(){var c=Array.prototype.slice.call(arguments);return this._request("get",{keys:c})},a.prototype.del=function(){var c=Array.prototype.slice.call(arguments);return this._request("del",{keys:c})},a.prototype.clear=function(){return this._request("clear")},a.prototype.getKeys=function(){return this._request("getKeys")},a.prototype.close=function(){var c=document.getElementById(this._frameId);c&&c.parentNode.removeChild(c),window.removeEventListener?window.removeEventListener("message",this._listener,!1):window.detachEvent("onmessage",this._listener),this._connected=!1,this._closed=!0},a.prototype._installListener=function(){var c=this;this._listener=function(e){var g,h,j,f;if(!c._closed&&e.data&&"string"==typeof e.data&&(h="null"===e.origin?"file://":e.origin,h===c._origin)){if("cross-storage:unavailable"!==e.data){if(-1!==e.data.indexOf("cross-storage:")&&!c._connected){if(c._connected=!0,!c._requests.connect){return}for(g=0;g<c._requests.connect.length;g++){c._requests.connect[g](j)}delete c._requests.connect}if("cross-storage:ready"!==e.data){try{f=JSON.parse(e.data)}catch(d){return}f.id&&c._requests[f.id]&&c._requests[f.id](f.error,f.result)}}else{if(c._closed||c.close(),!c._requests.connect){return}for(j=new Error("Closing client. Could not access localStorage in hub."),g=0;g<c._requests.connect.length;g++){c._requests.connect[g](j)}}}},window.addEventListener?window.addEventListener("message",this._listener,!1):window.attachEvent("onmessage",this._listener)},a.prototype._poll=function(){var f,c,d;f=this,d="file://"===f._origin?"*":f._origin,c=setInterval(function(){return f._connected?clearInterval(c):(f._hub&&f._hub.postMessage("cross-storage:poll",d),void 0)},1000)},a.prototype._createFrame=function(d){var c,f;c=window.document.createElement("iframe"),c.id=this._frameId;for(f in a.frameStyle){a.frameStyle.hasOwnProperty(f)&&(c.style[f]=a.frameStyle[f])}return window.document.body.appendChild(c),c.src=d,c},a.prototype._request=function(f,c){var d,g;return this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):(g=this,g._count++,d={id:this._id+":"+g._count,method:"cross-storage:"+f,params:c},new this._promise(function(l,j){var m,k,h;m=setTimeout(function(){g._requests[d.id]&&(delete g._requests[d.id],j(new Error("Timeout: could not perform "+d.method)))},g._timeout),g._requests[d.id]=function(n,e){return clearTimeout(m),delete g._requests[d.id],n?j(new Error(n)):(l(e),void 0)},Array.prototype.toJSON&&(k=Array.prototype.toJSON,Array.prototype.toJSON=null),h="file://"===g._origin?"*":g._origin,g._hub.postMessage(JSON.stringify(d),h),k&&(Array.prototype.toJSON=k)}))},"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof exports?exports.CrossStorageClient=a:"function"==typeof define&&define.amd?define([],function(){return a}):b.CrossStorageClient=a}(this);(function(){const c="pyff_discovery_choices";const a=60*10*1000;function b(e,g,d,f){f=f||{};this.storage_url=g;this.sp_entity_id=d;this.mdq_url=e}b._querystring=(function(g){var f={};for(var d=0;d<g.length;++d){var e=g[d].split("=",2);if(e.length!==2){continue}f[e[0]]=decodeURIComponent(e[1].replace(/\+/g," "))}return f})(window.location.search.substr(1).split("&"));b.prototype.get_storage=function(){return new CrossStorageClient(this.storage_url)};b.prototype.json_mdq_get=function(d){return $.ajax({datatype:"json",url:this.mdq_url+d+".json"}).then(function(e){if($.isArray(e)){e=e[0]}return e},function(g,f,e){console.log(f);return Promise.reject(e)})};b._now=function(){if(typeof Date.now==="function"){return Date.now()}return new Date().getTime()};b.prototype.choices=function(){var d=this;var e=this.get_storage();return e.onConnect().then(function(){console.log(c);return e.get(c)}).then(function(g){g=g||"[]";var f=JSON.parse(g)||[];f.sort(function(i,h){if(i.use_count<h.use_count){return 1}if(i.use_count>h.use_count){return -1}return 0});while(f.length>3){f.pop()}f.forEach(function(i){var h=i.entity;if(h&&h.entityID&&!h.entity_id){h.entity_id=h.entityID}if(h&&!h.entity_icon&&h.icon){h.entity_icon=h.icon}});return f})};b.prototype.each=function(f){var d=this;var e=this.get_storage();return e.onConnect().then(function(){console.log(c);return e.get(c)}).then(function(h){var g=JSON.parse(h||"[]")||[];g.sort(function(j,i){if(j.use_count<i.use_count){return 1}if(j.use_count>i.use_count){return -1}return 0});while(g.length>3){g.pop()}return Promise.all(g.map(function(l,k){var j=l.last_refresh||-1;if(j==-1||j+a<b._now()){var m=d.json_mdq_get(l.entity.entity_id).then(function(i){console.log(i);if(i){l.entity=i;l.last_refresh=b._now()}return f(l.entity)});return m}else{return new Promise(function(n,i){return f(l.entity)})}})).then(function(){return e.set(c,JSON.stringify(g))})})["catch"](function(g){console.log(g)})};b.prototype.saml_discovery_response=function(d){var e=this;return e.add(d).then(function(){console.log("returning discovery response...");var h=b._querystring;var f;if(h["return"]){f=h["return"].indexOf("?")===-1?"?":"&";var g=h.returnIDParam;if(!g){g="entityID"}console.log(h["return"]+f+g+"="+d);window.location=h["return"]+f+g+"="+d}})};b._incr_use_count=function(d,f){for(var e=0;e<f.length;e++){if(f[e].entity.entity_id==d||f[e].entity.entityID==d){var g=f[e].use_count;f[e].use_count+=1;return g}}return -1};b._sha1_id=function(d){return"{sha1}"+hex_sha1(d)};b.prototype.add=function(f){var e=this.get_storage();var d=this;return e.onConnect().then(function(){return e.get(c)}).then(function(h){var g=JSON.parse(h||"[]")||[];console.log("found current list...");console.log(g);var i;if(b._incr_use_count(f,g)==-1){i=d.json_mdq_get(b._sha1_id(f)).then(function(j){console.log("mdq found entity: ",j);g.push({last_refresh:b._now(),use_count:1,entity:j});return g})}else{i=Promise.resolve(g)}console.log("final promise...");console.log(i);return i.then(function(j){console.log("setting...");console.log(j);return e.set(c,JSON.stringify(j))})})};b.prototype.remove=function(f){var e=this.get_storage();var d=this;return e.onConnect().then(function(){return e.get(c)}).then(function(h){var g=JSON.parse(h||"[]")||[];return g.filter(function(i){return i.entity.entity_id!=f&&i.entity.entityID!=f})}).then(function(g){return e.set(c,JSON.stringify(g))})};(function(e,f){var d=false;if(typeof exports==="object"){d=exports;if(exports&&typeof global==="object"&&global&&global===global.global){e=global}}if(typeof define==="function"&&typeof define.amd==="object"&&define.amd){define(function(){return b})}else{if(d){if(typeof module==="object"&&module&&module.exports===d){module.exports=b}else{d.DiscoveryService=b}}else{e.DiscoveryService=b}}}(this))}());