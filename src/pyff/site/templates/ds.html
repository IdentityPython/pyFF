<!DOCTYPE HTML>
## -*- coding: utf-8 -*-
<html xmlns="http://www.w3.org/1999/html">
<head>
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/static/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/js/select2/select2.css" rel="stylesheet"/>
    <link href="/static/css/flags.css" rel="stylesheet"/>
    <link href="/static/css/pyff.css" rel="stylesheet"/>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/json2.js"></script>
    <script type="text/javascript" src="/static/js/jstorage.js"></script>
    <script type="text/javascript" src="/static/js/select2.min.js"></script>
    <title>Please login...</title>
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript" src="/static/js/pyff.js"></script>

    <script type="text/javascript">

        $(function() {
            function ds_default_select() {
                var idp = $.jStorage.get('pyff.discovery.idp');
                if (idp) {
                    return ds_select(idp);
                } else {
                    return false;
                }
            }
            function ds_select(entityID) {
                var ret = '${ret}'
                var qs
                if (ret.indexOf('?') === -1) {
                    qs = '?'
                } else {
                    qs = '&'
                }
                if ($('#remember').is(':checked')) {
                    $.jStorage.set('pyff.discovery.idp',entityID);
                }
                window.location = '${ret}'+qs+'${returnIDParam}='+entityID;
                return false;
            }

            function contains_idp(idp,lst) {
                for (var i = 0; i < lst.length; i++) {
                    var item = lst[i];
                    if (item['entityID'] == idp['entityID']) {
                        return true;
                    }
                }
                return false;
            }

            function addIdP(item) {
                var idps = $.jStorage.get('pyff.discovery.idps',[]);
                //console.log(item);
                if (!contains_idp(item,idps)) {
                    idps.unshift(item);
                }
                while (idps.length > 3) {
                    idps.pop()
                }
                $.jStorage.set('pyff.discovery.idps',idps);
                return ds_select(item['entityID']);
            }

            $('#quickLinks').dsQuickLinks();
            $(".select").click(function(e) {
                e.preventDefault();
                return ds_select($(this).attr('href'));
            });
            function find_idp(id,lst) {
                for (var i = 0; i < lst.length; i++) {
                    if (id == lst[i].entityID) {
                        return i
                    }
                }
                return -1
            }
            $(".unselect").click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                var id = $(this).attr('rel');
                var idps = $.jStorage.get('pyff.discovery.idps',[]);
                var idx = find_idp(id,idps);
                if (idx != -1) {
                    idps.splice(idx,1);
                    $.jStorage.set('pyff.discovery.idps',idps);
                    $(this).parent().parent().remove();
                }
            });

            $('.sp').dsRelyingParty();
            $('#select').dsSelect();
            $('#select').change(function(ev) {
                $.ajax({
                    datatype: 'json',
                    url: '/metadata/'+ev['val']+".json",
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            //console.log("fetched: "+data[i]);
                            return addIdP(data[i]);
                        }
                    }
                });
            });
            $("img.fallback-icon").error(function(e) {
                $(this).error(function(e) {});
                $(this).addClass("icon-user").removeClass("img-polaroid");
            });
            $('#switch-to-search').click(function (ev) {
                ev.preventDefault();
                $('#search').tab('show');
                $('#select').select2("focus");
            });
            $('a[href="#search"]').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
                $('#select').select2("focus");
            });
            $('a[data-toggle="tab"]').click(function (e) {
                e.preventDefault();
                $(this).tab('show');
            });
            $('.message > button.close').click(function(e) {
                //console.log(e);
                //console.log($(this));
                var closed = $.jStorage.get('pyff.discovery.messages',{});
                var id = $(this).parentsUntil('.message').attr('id');
                $(this).parent().each(function() {
                    //console.log($(this).attr('id'));
                    closed[$(this).attr('id')] = true;
                });
                $.jStorage.set('pyff.discovery.messages',closed);
            });
            $('.message').each(function () {
                var closed = $.jStorage.get('pyff.discovery.messages',{});
                if (closed[$(this).attr('id')]) {
                    $(this).hide();
                }
            });

            function switch_to_search() {
                $('#search-tab').addClass('active');
                $('#search-tab a').click();
            }

            function switch_to_suggested() {
                $('#suggested-tab').click();
            }

            function tab_focus() {
                var idps = $.jStorage.get('pyff.discovery.idps',[]);
                if (idps.length === 0) {
                    $('#idptab a[href="#search"]').tab('show');
                    $('#idptab a[href="#suggested"]').parent().addClass('hide');
                    $('#select').select2("focus");
                } else {
                    $('#idptab a[href="#suggested"]').parent().removeClass('hide');
                    $('#idptab a[href="#suggested"]').tab('show');
                }
            }
            //ds_default_select();
            tab_focus();
        });
    </script>
<body>

<div id="wrap">
    <div class="container-fluid">
        <!-- div class="navbar navbar-fixed-top">
            <div class="navbar-inner" style>
                <div style="margin-left: 40px;">
                    <a class="brand" href="#">Select a Login Provider</a>
                </div>
            </div>
        </div -->
        <div class="span8">
            <h2>Please Login</h2>
            <div class="tabbable tabs-below">
                <ul id="idptab" class="nav nav-tabs">
                    <li><a href="#suggested" data-toggle="tab">Suggested</a></li>
                    <li><a href="#search" data-toggle="tab">All Login Providers</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane" id="suggested">
                        <div id="quickLinks"></div>
                        <div class="clearfix"></div>
                        <!-- a id="switch-to-search" href="#">Help me find my Identity Provider!</a -->
                    </div>
                    <div class="tab-pane" id="search" style="min-height: 100px;">
                        <div style="width: 99%;" id="select"></div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info message" id="remember-message">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4>Remember choice</h4>
                <form class="form-inline">
                    <label class="checkbox"><input id="remember" type="checkbox"> Remember my choice and never show me this page again!</label>
                </form>
            </div>
        </div>
        <div class="span4 hidden-phone">
            <h4 class="sp sp-name"></h4>
            <div class="sp sp-icon"></div>
            <div class="sp sp-description"></div>

            <div class="alert alert-success message" id="first-time-user">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4>Choosing a Login Provider</h4>
                <p>If you are using a new computer or a new browser you will have to serch for your preferred login provider.</p>
                <p>The next time we will try our best to remember your choice for your convenience.</p>
            </div>
            <div class="alert alert-info message" id="about">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4>What is this?</h4>
                <p>You have asked to login to a service (details displayed above) that requires you to login. You
                need to choose a login provider - typically your home organization - and optionally choose to remember
                this choice so we don't have to bother you again!</p>
            </div>
        </div>
    </div>
    <div id="push"></div>
</div>
<div id="footer">
    <div class="container" style="padding-top: 50px">
        <div class="row-fluid">
            <div class="span12">
                <div class="fluid-row">

                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>