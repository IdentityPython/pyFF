<div>
    <style>
        #graph { overflow: none; }
        .node rect {
          cursor: move;
          fill-opacity: .9;
          shape-rendering: crispEdges;
        }

        .node text {
          pointer-events: none;
          text-shadow: 0 1px 0 #fff;
        }

        .link {
          fill: none;
          stroke: #000;
          stroke-opacity: .2;
        }

        .link:hover {
          stroke-opacity: .5;
        }
    </style>
    <script type="text/javascript">

    (function ($) {
      $('.ispinner .btn:first-of-type').on('click', function() {
        $('.ispinner input').val( parseInt($('.ispinner input').val(), 10) + 1);
      });
      $('.ispinner .btn:last-of-type').on('click', function() {
        $('.ispinner input').val( parseInt($('.ispinner input').val(), 10) - 1);
      });
    })(jQuery);


    var opts = {
        lines: 13, // The number of lines to draw
        length: 20, // The length of each line
        width: 10, // The line thickness
        radius: 30, // The radius of the inner circle
        corners: 1, // Corner roundness (0..1)
        rotate: 0, // The rotation offset
        direction: 1, // 1: clockwise, -1: counterclockwise
        color: '#000', // #rgb or #rrggbb or array of colors
        speed: 1, // Rounds per second
        trail: 60, // Afterglow percentage
        shadow: false, // Whether to render a shadow
        hwaccel: false, // Whether to use hardware acceleration
        className: 'jsspinner', // The CSS class to assign to the spinner
        zIndex: 2e9, // The z-index (defaults to 2000000000)
        top: '70%', // Top position relative to parent
        left: '50%' // Left position relative to parent
    };
    var spinner = new Spinner(opts);

    $(document).ready(function() {

        $("form.graph-nav-form").on('submit', function(e) {
            e.preventDefault();
            var state = {};
            var left = $("#left").val();
            var right = $("#right").val();
            var n = $('#n').val();
            state['href'] = "/reports/attribute_graph/"+left+"/"+right+"/"+n;
            $.bbq.pushState(state);
            return true;
        });

        var spinto = document.getElementById('graph');
        spinner.spin(spinto);

        var width = 600,
            height = 800;

        var formatNumber = d3.format("d"),
            format = function(d) { return formatNumber(d) },
            color = d3.scale.category20c();

        var svg = d3.select("#graph")
                .append("svg")
                .attr("viewBox","0 0 600 800")
                .attr("width", width+10)
                .attr("height", height+60)
                .append("g");

        var sankey = d3.sankey()
            .nodeWidth(25)
            .nodePadding(5)
            .size([width, height]);

        var left = $("#left").val();
        var right = $("#right").val();

        if (left == right) {
            spinner.stop();
            $("#graph").html("<br/><div class=\"alert alert-warning\" role=\"alert\">{{ gettext('Empty graph') }}</div>")
        } else {
            var path = sankey.link();
            d3.json("/reports/attribute_graph_api?left=" + left + "&right=" + right, function (error, graph) {

                sankey
                        .nodes(graph.nodes)
                        .links(graph.links)
                        .layout(32);

                spinner.stop();

                var link = svg.append("g").selectAll(".link")
                        .data(graph.links)
                        .enter().append("path")
                        .attr("class", "link")
                        .attr("d", path)
                        .style("stroke-width", function (d) {
                            return Math.max(1, d.dy);
                        })
                        .sort(function (a, b) {
                            return b.dy - a.dy;
                        });

                link.append("title")
                        .text(function (d) {
                            return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value);
                        });

                var node = svg.append("g").selectAll(".node")
                        .data(graph.nodes)
                        .enter().append("g")
                        .filter(function(d) { return d.sourceLinks.length > 0 || d.targetLinks.length > 0 })
                        .attr("class", "node")
                        .attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        })
                        .on('click', function (d) {
                            console.log(d);
                        })
                        .call(d3.behavior.drag()
                                .origin(function (d) {
                                    return d;
                                })
                                .on("dragstart", function () {
                                    this.parentNode.appendChild(this);
                                })
                                .on("drag", dragmove));

                node.append("rect")
                        .attr("height", function (d) {
                            return d.dy;
                        })
                        .attr("width", sankey.nodeWidth())
                        .style("fill", function (d) {
                            return d.color = color(d.name.replace(/ .*/, ""));
                        })
                        .style("stroke", function (d) {
                            return d3.rgb(d.color).darker(2);
                        })
                        .append("title")
                        .text(function (d) {
                            return d.name + "\n" + format(d.value);
                        });

                node.append("text")
                        .attr("x", -6)
                        .attr("y", function (d) {
                            return d.dy / 2;
                        })
                        .attr("dy", ".35em")
                        .attr("text-anchor", "end")
                        .attr("transform", null)
                        .text(function (d) {
                            return d.name;
                        })
                        .filter(function (d) {
                            return d.x < width / 2;
                        })
                        .attr("x", 6 + sankey.nodeWidth())
                        .attr("text-anchor", "start");

                function dragmove(d) {
                    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
                    sankey.relayout();
                    link.attr("d", path);
                }

            });
        }
    });
    </script>
    <div class="text-center">
        <form action="#" class="form form-inline graph-nav-form">
            <div class="form-group small">
                <span><b>From</b></span>
                <select id="left" class="form-control" name="left">
                     {% for alias,attr in attributes.iteritems() %}
                        <option value="{{alias|u}}" {% if attr == left %}selected="selected"{% endif %}>{{alias}}</option>
                    {% endfor %}
                </select>
                <span ><b>to</b></span>
                <select id="right" class="form-control" name="right">
                    {% for alias,attr in attributes.iteritems() %}
                        <option value="{{alias|u}}" {% if attr == right %}selected="selected"{% endif %}>{{alias}}</option>
                    {% endfor %}
                </select>
                <span><b>where count &gt; </b></span>
                <div class="input-group ispinner">
                    <input type="text" class="form-control" id="n" name="n" value="{{n}}"/>
                    <div class="input-group-btn-vertical">
                      <button class="btn btn-default"><i class="fa fa-caret-up"></i></button>
                      <button class="btn btn-default"><i class="fa fa-caret-down"></i></button>
                    </div>
                </div>
                <input class="btn btn-success" type="submit" value="Go!">
            </div>
        </form>
    </div>
    <div class="d3" id="graph"></div>
</div>