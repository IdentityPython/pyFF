<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="{{scheme}}://{{vhost}}/static/css/font-awesome.min.css">

    <!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.2/bootstrap-material-design.css" />
    <link rel="stylesheet" href="{{scheme}}://{{vhost}}/static/css/oneclick.css" />
    <link href="//fonts.googleapis.com/css?family=Roboto:100,200,300,400,500,600,700" type="text/css" rel="stylesheet">
    -->
    
    <!-- Pull in zoid and the 'oneclick discovery' zoid component -->
    <script src="{{scheme}}://{{vhost}}/static/js/zoid.min.js"></script>
    <script src="{{scheme}}://{{vhost}}/static/js/sha1.js"></script>
    <script src="{{scheme}}://{{vhost}}/static/js/ds-client.js"></script>
    <script src="{{scheme}}://{{vhost}}/oneclick/component.js"></script>
</head>

<body>
    <div class="btn-group" role="group" aria-label="Identity Provider Choice">
        <button type="button" class="btn btn-primary identityprovider" data-href="">
            <i class="fa fa-university"></i>
        </button>
        <button type="button" class="btn btn-outline-primary btn-block identityprovider" id="idpbutton">
            <i id="spinner" class='fa fa-circle-o-notch fa-spin'></i>
        </button>
    </div>
    <script>
        var mdq_url = "{{scheme}}://{{vhost}}/metadata/";
        var storage_url = "local://";
        var defaultText = "Check Access";

        if (window.xprops.StorageURL) {
            storage_url = window.xprops.StorageURL;
        }

        if (window.xprops.MDQ) {
            mdq_url = window.xprops.MDQ;
        }

        var ds = new DiscoveryService(mdq_url, storage_url);
        ds.choices().then(function (items) {
            var count = 0;
            console.log(items);
            if (items && items.length > 0 && items[0].entity) { // or things have gone very wrong...
                var entity = items[0].entity;
                document.getElementById('idpbutton').innerText = entity.title;
                document.getElementById('idpbutton').dataset['href'] = entity.entityID;
                count += 1;
            }
            return count;
        }).then(function(count) {
            if (count == 0) {
                document.getElementById('idpbutton').innerText = defaultText;
                document.getElementById('idpbutton').dataset['href'] = "";
            }
            document.querySelectorAll('button.identityprovider').forEach(function (item) {
                item.addEventListener('click', function(event) {
                        event.preventDefault();
                        setTimeout(function() {
                            var params = {'return': window.xprops.returnURL};
                            var entity_id = event.target.dataset.href; // TODO - this only works if we clicked the <a/>
                            if (!entity_id) {
                                entity_id = "";
                            }
                            // Since we had a click, call-back the parent page to let them know the entityID and the response URL
                            ds.do_saml_discovery_response(entity_id, params).then(function (url) {
                                window.xprops.onInstitutionClicked(url, entity_id);
                                window.xchild.close();
                            });

                        }, 100);
                    })
                });
        });


    </script>
    
</body>
</html>